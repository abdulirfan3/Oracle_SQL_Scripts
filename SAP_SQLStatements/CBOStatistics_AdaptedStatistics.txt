SELECT NULL TABLE_NAME, NULL ADAPTED_OBJECT, NULL OBJECT_TYPE, 
 NULL DBSTATC, NULL SAP_NOTE_1020260, NULL STAT_DETAILS FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL TABLE_NAME, NULL ADAPTED_OBJECT, NULL OBJECT_TYPE, 
 NULL DBSTATC, NULL SAP_NOTE_1020260, NULL STAT_DETAILS FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    '%' OWNER,
    '%' TABLE_NAME,
    'NO' INCLUDE_DELIVERED_STATS    /* NO -> no display of delivered statistics, 
                                       SINGLE -> no display of full delivered statistics, 
                                       ALL -> display of all delivered statistics */
  FROM
    DUAL
),
ADAPTED_STATS AS
( SELECT /*+ MATERIALIZE */
    T.OWNER,
    T.TABLE_NAME,
    'TABLE' OBJECT_TYPE,
    T.TABLE_NAME OBJECT_NAME
  FROM
    BASIS_INFO BI,
    DBA_TABLES T
  WHERE
    T.OWNER LIKE BI.OWNER AND
    T.TABLE_NAME LIKE BI.TABLE_NAME AND
    T.USER_STATS = 'YES'
  UNION ALL
  ( SELECT 
      I.TABLE_OWNER OWNER,
      I.TABLE_NAME,
      'INDEX' OBJECT_TYPE,
      I.INDEX_NAME
    FROM
      BASIS_INFO BI,
      DBA_INDEXES I
    WHERE
      I.TABLE_OWNER LIKE BI.OWNER AND
      I.TABLE_NAME LIKE BI.TABLE_NAME AND
      USER_STATS = 'YES'
  )
  UNION ALL
  ( SELECT 
      C.OWNER,
      C.TABLE_NAME,
      'COLUMN' OBJECT_TYPE,
      C.COLUMN_NAME
    FROM
      BASIS_INFO BI,
      DBA_TAB_COLUMNS C
    WHERE
      C.OWNER LIKE BI.OWNER AND
      C.TABLE_NAME LIKE BI.TABLE_NAME AND
      C.USER_STATS = 'YES'
  )
),
DBSTATC_MASTER_SWITCH AS
( SELECT
    D.DBOBJ TABLE_NAME,
    D.ACTIV
  FROM
    BASIS_INFO BI,
    DBSTATC D
  WHERE
    D.DBOBJ LIKE BI.TABLE_NAME AND
    D.DBTYP IN (' ', 'ORACLE') AND
    D.ACTIV IN ('I', 'R') 
),
DBSTATC_DETAIL_SETTING AS
( SELECT /*+ MATERIALIZE */ DISTINCT
    D.DBOBJ TABLE_NAME,
    DECODE(SUBSTR(D.DOTYP, 1, 1), 'T', 'TABLE', 'I', 'INDEX', 'C', 'COLUMN') OBJECT_TYPE,
    DECODE(SUBSTR(D.DOTYP, 1, 1), 'T', D.DBOBJ, D.OBJOW) OBJECT_NAME,
    D.DOTYP,
    D.OBJEC
  FROM
    BASIS_INFO BI,
    DBSTATC D,
    DBSTATC_MASTER_SWITCH DM
  WHERE
    D.DBOBJ LIKE BI.TABLE_NAME AND
    D.DBOBJ = DM.TABLE_NAME AND
    D.DBTYP IN (' ', 'ORACLE') AND
    D.ACTIV = 'A' AND
    D.DOTYP IN ('TB', 'TL', 'TR', 'CD', 'IB', 'IC', 'ID', 'IL', 'IR' ) 
),
DELIVERED_STATS AS
( SELECT 'E' STAT_LEVEL, 'AUSP' TABLE_NAME FROM DUAL UNION
  SELECT 'E', 'BKPF' FROM DUAL UNION
  SELECT 'E', 'MSEG' FROM DUAL UNION
  SELECT 'S', '/SAPAPO/MATLOC' FROM DUAL UNION
  SELECT 'S', '/SAPAPO/ORDADM_I' FROM DUAL UNION
  SELECT 'S', 'AFKO' FROM DUAL UNION
  SELECT 'S', 'AFPO' FROM DUAL UNION
  SELECT 'S', 'AFVC' FROM DUAL UNION
  SELECT 'S', 'AUFK' FROM DUAL UNION
  SELECT 'S', 'BBP_PDHGP' FROM DUAL UNION
  SELECT 'S', 'BDCP2' FROM DUAL UNION
  SELECT 'S', 'CATSDB' FROM DUAL UNION
  SELECT 'S', 'DFKKOP' FROM DUAL UNION
  SELECT 'S', 'DRAW' FROM DUAL UNION
  SELECT 'S', 'LTAK' FROM DUAL UNION
  SELECT 'S', 'MLST' FROM DUAL UNION
  SELECT 'S', 'PAYR' FROM DUAL UNION
  SELECT 'S', 'RSBATCHDATA' FROM DUAL UNION
  SELECT 'S', 'SWWWIHEAD' FROM DUAL UNION
  SELECT 'S', 'TBTCO' FROM DUAL UNION
  SELECT 'S', 'UPSITX' FROM DUAL UNION
  SELECT 'S', 'VEPO' FROM DUAL UNION
  SELECT 'F', 'ARFCRSTATE' FROM DUAL UNION
  SELECT 'F', 'ARFCSDATA' FROM DUAL UNION
  SELECT 'F', 'ARFCSSTATE' FROM DUAL UNION
  SELECT 'F', 'DDXTT' FROM DUAL UNION
  SELECT 'F', 'DDXTF' FROM DUAL UNION
  SELECT 'F', 'QREFTID' FROM DUAL UNION
  SELECT 'F', 'SXMSCLUP' FROM DUAL UNION
  SELECT 'F', 'SXMSCLUP2' FROM DUAL UNION
  SELECT 'F', 'SXMSCLUR' FROM DUAL UNION
  SELECT 'F', 'SXMSCLUR2' FROM DUAL UNION
  SELECT 'F', 'SXMSPEMAS' FROM DUAL UNION
  SELECT 'F', 'SXMSPEMAS2' FROM DUAL UNION
  SELECT 'F', 'SXMSPERROR' FROM DUAL UNION
  SELECT 'F', 'SXMSPERRO2' FROM DUAL UNION
  SELECT 'F', 'SXMSPHIST' FROM DUAL UNION
  SELECT 'F', 'SXMSPHIST2' FROM DUAL UNION
  SELECT 'F', 'SXMSPMAST' FROM DUAL UNION
  SELECT 'F', 'SXMSPMAST2' FROM DUAL UNION
  SELECT 'F', 'SXMSPVERS' FROM DUAL UNION
  SELECT 'F', 'SXMSPVERS2' FROM DUAL UNION
  SELECT 'F', 'TATAF' FROM DUAL UNION
  SELECT 'F', 'TESTDATRNRPART0' FROM DUAL UNION
  SELECT 'F', 'TRBAT' FROM DUAL UNION
  SELECT 'F', 'TRBAT2' FROM DUAL UNION
  SELECT 'F', 'TRFCQDATA' FROM DUAL UNION
  SELECT 'F', 'TRFCQIN' FROM DUAL UNION
  SELECT 'F', 'TRFCQOUT' FROM DUAL UNION
  SELECT 'F', 'TRFCQSTATE' FROM DUAL UNION
  SELECT 'F', 'SMOEJOBID' FROM DUAL UNION
  SELECT 'F', 'SMOFCDBHD' FROM DUAL UNION
  SELECT 'F', 'SMOFCMPDAT' FROM DUAL UNION
  SELECT 'F', 'SMOFCMPHD' FROM DUAL UNION
  SELECT 'F', 'SMOFCMPOBJ' FROM DUAL UNION
  SELECT 'F', 'SMOHJOBQ' FROM DUAL UNION
  SELECT 'F', 'SMOHMSGQ' FROM DUAL UNION
  SELECT 'F', 'SMOHMSGQRE' FROM DUAL UNION
  SELECT 'F', 'SMOHSITEQ' FROM DUAL UNION
  SELECT 'F', 'SMOHSITEQEX' FROM DUAL UNION
  SELECT 'F', 'SMOHSITEQRD' FROM DUAL UNION
  SELECT 'F', 'XI_AF_SVC_ID_MAP' FROM DUAL
),
TABLE_LIST AS 
( SELECT TABLE_NAME FROM ADAPTED_STATS UNION
  SELECT TABLE_NAME FROM DBSTATC_MASTER_SWITCH UNION
  SELECT TABLE_NAME FROM DBSTATC_DETAIL_SETTING
),
STATISTIC_DETAILS AS
( SELECT DISTINCT
    AD.TABLE_NAME,
    AD.OBJECT_TYPE,
    AD.OBJECT_NAME,
    'BLOCKS: ' || T.BLOCKS || ', NUM_ROWS: ' || T.NUM_ROWS || ', AVG_ROW_LEN: ' || T.AVG_ROW_LEN STAT_DETAILS
  FROM
    ( SELECT TABLE_NAME, OBJECT_TYPE, OBJECT_NAME FROM ADAPTED_STATS UNION
      SELECT TABLE_NAME, OBJECT_TYPE, OBJECT_NAME FROM DBSTATC_DETAIL_SETTING ) AD,
    DBA_TABLES T
  WHERE
    AD.OBJECT_TYPE = 'TABLE' AND
    AD.OBJECT_NAME = T.TABLE_NAME
  UNION ALL
  ( SELECT DISTINCT
      AD.TABLE_NAME,
      AD.OBJECT_TYPE,
      AD.OBJECT_NAME,
      'BLEVEL: ' || I.BLEVEL || ', LEAF_BLOCKS: ' || I.LEAF_BLOCKS || ', NUM_ROWS: ' || I.NUM_ROWS || ', DISTINCT_KEYS: ' || 
        I.DISTINCT_KEYS || ', CLUSTERING_FACTOR: ' || I.CLUSTERING_FACTOR STAT_DETAILS
    FROM
      ( SELECT TABLE_NAME, OBJECT_TYPE, OBJECT_NAME FROM ADAPTED_STATS UNION
        SELECT TABLE_NAME, OBJECT_TYPE, OBJECT_NAME FROM DBSTATC_DETAIL_SETTING ) AD,
      DBA_INDEXES I
    WHERE
      AD.OBJECT_TYPE = 'INDEX' AND
      AD.TABLE_NAME = I.TABLE_NAME AND
      AD.OBJECT_NAME = I.INDEX_NAME
  )
  UNION ALL
  ( SELECT DISTINCT
      AD.TABLE_NAME,
      AD.OBJECT_TYPE,
      AD.OBJECT_NAME,
      'NUM_DISTINCT: ' || C.NUM_DISTINCT STAT_DETAILS
    FROM
      ( SELECT TABLE_NAME, OBJECT_TYPE, OBJECT_NAME FROM ADAPTED_STATS UNION
        SELECT TABLE_NAME, OBJECT_TYPE, OBJECT_NAME FROM DBSTATC_DETAIL_SETTING ) AD,
      DBA_TAB_COLUMNS C
    WHERE
      AD.OBJECT_TYPE = 'COLUMN' AND
      AD.TABLE_NAME = C.TABLE_NAME AND
      AD.OBJECT_NAME = C.COLUMN_NAME
  )
)
SELECT
  *
FROM
( SELECT
    TL.TABLE_NAME,
    AD.OBJECT_NAME ADAPTED_OBJECT,
    AD.OBJECT_TYPE,
    DECODE(DM.ACTIV, 
      'I', 'Ignore', 
      'R', 'Rule' || DECODE(DD.DOTYP, NULL, ' (missing rule definition)', ' (' || 
      DECODE(DD.DOTYP, 
        'TB', 'BLOCKS', 
        'TL', 'AVG_COL_LEN', 
        'TR', 'NUM_ROWS',
        'CD', 'NUM_DISTINCT',
        'IB', 'LEAF_BLOCKS',
        'IC', 'CLUSTERING_FACTOR',
        'ID', 'DISTINCT_KEYS',
        'IL', 'BLEVEL',
        'IR', 'NUM_ROWS') || ' of ' || DD.OBJECT_NAME || 
      DECODE(SUBSTR(DD.OBJEC, 1, 1), 
        '+', ' at least ', 
        '-', ' not more than ',
        ' equal to ') ||
      ABS(DD.OBJEC) || ')')) DBSTATC,
    DECODE(DS.STAT_LEVEL, 
      'F', 'Full statistics',
      'S', 'Single statistics',
      'E', 'Extended statistics') SAP_NOTE_1020260,
    S.STAT_DETAILS
  FROM
    BASIS_INFO BI,
    TABLE_LIST TL,
    ADAPTED_STATS AD,
    DBSTATC_MASTER_SWITCH DM,
    DBSTATC_DETAIL_SETTING DD,
    DELIVERED_STATS DS,
    STATISTIC_DETAILS S
  WHERE
    TL.TABLE_NAME = AD.TABLE_NAME (+) AND
    TL.TABLE_NAME = DM.TABLE_NAME (+) AND
    TL.TABLE_NAME = DD.TABLE_NAME (+) AND
    TL.TABLE_NAME = DS.TABLE_NAME (+) AND
    TL.TABLE_NAME = S.TABLE_NAME (+) AND
    ( AD.OBJECT_NAME IS NULL OR 
      DD.OBJECT_NAME IS NULL OR 
      AD.OBJECT_TYPE = DD.OBJECT_TYPE AND AD.OBJECT_NAME = DD.OBJECT_NAME ) AND
    ( S.OBJECT_NAME IS NULL OR
      S.OBJECT_NAME = AD.OBJECT_NAME AND S.OBJECT_TYPE = AD.OBJECT_TYPE OR 
      S.OBJECT_NAME = DD.OBJECT_NAME AND S.OBJECT_TYPE = DD.OBJECT_TYPE ) AND
    ( BI.INCLUDE_DELIVERED_STATS = 'NO' AND ( DS.STAT_LEVEL IS NULL OR DS.STAT_LEVEL = 'E' ) OR
      BI.INCLUDE_DELIVERED_STATS = 'SINGLE' AND ( DS.STAT_LEVEL IS NULL OR DS.STAT_LEVEL IN ( 'E', 'S' ) ) OR
      BI.INCLUDE_DELIVERED_STATS = 'ALL' )
  ORDER BY
    1, 3, 2
)
));

